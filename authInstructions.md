# Authorisation and Authentication Instructions

Please refer to [Issues Fixed](#issues-fixed) for the issues that have been fixed.


## 1. Sign Up

* From the frontend, request will be passed from the body as : 
```json
{
    "firstName" : "Ashutosh",
    "lastName" : "Krishna",
    "email" : "sekado1151@brosj.net",
    "password" : "Asdfghjkl1@",
    "confirmPassword" : "Asdfghjkl1@",
    "dob" : "2000-05-20",
    "gender" : "Male"
}
```

* All the fields will be validated as per the [validations](#validations).
* If the user already exists, error with status code of 400 will be sent to frontend with a message.
* The route for the signup will be {{URL}}/signup


## 2. Generating Link

* When the signup form is submitted, all the fields(except confirmPassword) are passed as payload to JWT.
* JWT signs the payload with a secret key and creates an activation link which expires in next 30 minutes.
* A verification email with an activation link(generated by JWT) is sent to the client.

## 2. Account Activation

* The route for activation will be {{URL}}/activation.
* Once the user clicks on the email, JWT decodes the token and extracts the user details. 
* In addition to this, the emailVerified field in the database is also set to true and all the details are then saved to the database.
* Now the account will be activated and ready to use.
* If there is any error on the backend part, or the verification link expires(30 minutes), an error with status code of 401 will be sent to the frontend.
* After account activation, if the user again clicks on the activation link within expiry time, a response of 200 with message **Already Verified** will be sent to frontend.

## 3. Log In

* From the frontend, request will be passed from the body as :

```json
{
    "email" : "lednor@mailpoof.com",
    "password" : "Asdfghjkl1@"
}
```
* The email and password will be validated against the [validations](#validations).
* Once validated successfully, the email is checked if it exists or not.
    * If it doesn't exist, an error with status code of 400 will be sent to frontend.
    * If it exists, the password is compared against the hashed password in the database.
        * If it doesn't match, an error with status code of 400 will be sent to frontend.
        * If it matches, the user is signed in and a token(expiring in 7 days) is generated.

## 4. Forgot Password

* From the frontend, request will be passed from the body as :

```json
{
    "email" : "sekado1151@brosj.net"
}
```
* The route will be {{URL}}/forgotpassword
* The email is matched in the database. If there's no user, an error with status code of 400 will be sent to frontend.
* If user is found, a password reset link(expires in 10 min) is sent to the email of the user. 
* Also, the resetPasswordLink field in the database is updated with the token generated.

## 5. Reset Password

* The route is {{URL}}/resetpassword
* Once the user clicks on the email, if it's expired or there is any error, an error with status code of 400 will be sent to frontend.
* If there is no error, the token is matched with the resetPasswordLink field in the user's database.
* If it matches, the following parameter is received from the frontend:
```json
{
    "newPassword" : "kuchhbhi1_"
}
```
* This password in the database is now updated with the newPassword(hashed) and resetPasswordLink is again made empty.
* If there's any error in updating the password, an error with status code of 400 will be sent to frontend.

## 6. Protected Routes

* All the form routes(GET and POST) have been made protected with a middleware.
* When the user logs in, the generated token is passed in the header by the frontend. The backend verifies the token with the one stored in the database.
    * If the user is verified, he/she can fill any form.
    * If the user is not verified, an error of status code 401 is passed to the frontend with a message of Unauthorised User. The frontend can render a page asking the user to login or signup.


### Validations

* firstName is **required**.
* email is **required**.
* password of **length 8-20** characters is **required** and it should contain:
    * atleast **one lowercase letter**
    * atleast **one uppercase letter**
    * atleast **one digit**
    * atleast **one special character** from **@,#,$,%,&,_**
* confirmPassword is **required** and should **match** with password
* dob should be a **valid** date(YYYY/MM/DD)
* gender should be either **Male** , **Female** , **Other** or **Prefer Not to Say**

### Issues Fixed

* Fixed error codes and messages.
* Created a separate section with detailed process of generating activation link.
* Increased the verification link expiration time to 30 minutes. If the user clicks on the link twice within the specified time, a response of 200 is sent to frontend with a message of Email already verified.
* We aren't saving tokens on user's device. JWT does this all for us internally.
* Included email in the payload while resetting password.
* We are just checking if the email satisfies our validations. Also, user can login only if he/she has verified his account. If the user tries to signup with an email that doesn't exist, the email sending process will throw error and the user cannot signup.
* Frontend can easily handle the issue of copy-pasting of confirmPassword.
* A valid date format is YYYY/MM/DD.